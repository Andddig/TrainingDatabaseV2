<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendant Packet - Training Database</title>
  <style>
    .packet-cover {
      border-radius: 14px;
      background: linear-gradient(140deg, rgba(16, 31, 79, 0.98), rgba(36, 80, 150, 0.96));
      color: #fff;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .packet-metric {
      font-size: 1.6rem;
      font-weight: 700;
    }
    .stage-badge {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .skill-row td {
      vertical-align: middle;
    }
    .signature-note {
      font-size: 0.85rem;
      color: #6c757d;
    }
    .call-targeted {
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
      border-radius: 0.3rem;
      transition: box-shadow 0.3s ease;
    }
  </style>
</head>
<body>
  <%- include('./partials/header', { user }) %>

  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="mb-0">Attendant Packet</h1>
      <a class="btn btn-outline-secondary" id="backToMyQualificationsButton" href="/qualifications/my">Back to My Qualifications</a>
    </div>

    <% const statusOptions = packets.reduce((acc, pkt) => {
         const raw = pkt.status || 'unknown';
         const value = raw.toLowerCase();
         if (!acc.some(option => option.value === value)) {
           acc.push({ value, label: raw.replace(/_/g, ' ') });
         }
         return acc;
       }, []);
    %>

    <section class="packet-selection-section mb-5">
      <div class="packet-selection-header d-flex justify-content-between align-items-start flex-wrap">
        <div>
          <p class="packet-selection-subtitle mb-1 text-muted">Choose or resume the packet you need to work on.</p>
          <h2 class="packet-selection-title mb-0">Packet Selection</h2>
        </div>
        <div class="packet-selection-meta d-flex align-items-center flex-wrap">
          <span class="badge badge-pill badge-light packet-selection-count"><%= packets.length %> packet<%= packets.length === 1 ? '' : 's' %></span>
          <% if (canCreatePacket) { %>
            <button type="button" class="btn btn-outline-light btn-sm packet-selection-new" data-create-packet data-packet-setup-mode="launcher">Start a new packet</button>
          <% } %>
        </div>
      </div>

      <div class="packet-selection-filters row align-items-end mt-3">
        <div class="col-md-6 mb-2">
          <label class="sr-only" for="packetSearchInput">Search packets</label>
          <input id="packetSearchInput" class="form-control form-control-sm packet-search" type="search" placeholder="Search candidate, officer, or status...">
        </div>
        <div class="col-md-4 mb-2">
          <label class="sr-only" for="packetStatusFilter">Filter by status</label>
          <select id="packetStatusFilter" class="form-control form-control-sm">
            <option value="">All statuses</option>
            <% statusOptions.forEach(option => { %>
              <option value="<%= option.value %>" <%= packet && packet.status && packet.status.toLowerCase() === option.value ? 'selected' : '' %>><%= option.label %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-2 mb-2 text-right text-md-left">
          <span class="text-muted packet-selection-hint">Click a card to open.</span>
        </div>
      </div>

      <% if (!packets.length) { %>
        <div class="packet-selection-empty">
          <p>No packets yet. Use the setup form below to capture your first call log.</p>
        </div>
      <% } else { %>
        <div class="packet-selection-grid mt-3">
          <% packets.forEach(pkt => {
               const candidateName = pkt.candidate && pkt.candidate.displayName ? pkt.candidate.displayName : 'Unknown Candidate';
               const officerName = pkt.sponsoringRescueOfficer && pkt.sponsoringRescueOfficer.displayName ? pkt.sponsoringRescueOfficer.displayName : 'Not assigned';
               const normalizedStatus = (pkt.status || 'unknown').toLowerCase();
               const friendlyStatus = (pkt.status || 'Unknown').replace(/_/g, ' ');
               const completedCallSheetCount = Array.isArray(pkt.callSheets)
                 ? pkt.callSheets.filter(call => call.status === 'completed').length
                 : 0;
               const progressPercent = Math.round(Math.min(completedCallSheetCount, 12) / 12 * 100);
          %>
            <article class="packet-card <%= packet && packet._id && packet._id.toString() === pkt._id.toString() ? 'packet-card--active' : '' %>" tabindex="0" role="button"
              data-packet-id="<%= pkt._id %>"
              data-status="<%= normalizedStatus %>"
              data-candidate="<%= candidateName %>"
              data-officer="<%= officerName %>"
              data-path="<%= pkt.eligibilityPath || '' %>">
              <div class="packet-card-top">
                <div>
                  <p class="packet-card-label mb-1">Candidate</p>
                  <h3 class="packet-card-title mb-1"><%= candidateName %></h3>
                  <p class="packet-card-meta mb-0">Officer: <%= officerName %></p>
                </div>
                <span class="packet-status-pill"><%= friendlyStatus %></span>
              </div>

              <div class="packet-card-stats mt-3">
                <div>
                  <p class="packet-card-label mb-0">Calls recorded</p>
                  <p class="packet-card-value mb-0"><%= completedCallSheetCount %>/12</p>
                </div>
              </div>

              <div class="packet-card-progress mt-3" aria-hidden="true">
                <div class="packet-card-progress-bar" style="width: <%= progressPercent %>%;"></div>
              </div>

              <div class="packet-card-actions">
                <span class="packet-card-progress-text">Progress <%= progressPercent %>%</span>
                <button type="button" class="btn btn-sm btn-light text-primary packet-card-open" data-packet-id="<%= pkt._id %>">Open packet</button>
              </div>
            </article>
          <% }) %>
        </div>
      <% } %>

      <div class="sr-only">
        <form method="GET" action="/qualifications/attendant-packet" class="form-inline" id="packetSelectorForm">
          <label class="mr-2">Active Packet</label>
          <select class="form-control mr-2" name="packet">
            <% packets.forEach(pkt => { %>
              <option value="<%= pkt._id %>" <%= packet && packet._id && packet._id.toString() === pkt._id.toString() ? 'selected' : '' %>>
                <%= pkt.candidate && pkt.candidate.displayName ? pkt.candidate.displayName : 'Unknown Candidate' %> - <%= pkt.status ? pkt.status.replace(/_/g, ' ') : 'Status unknown' %>
              </option>
            <% }) %>
          </select>
        </form>
      </div>
    </section>

    <div class="packet-cover">
      <div class="row">
        <div class="col-md-8">
          <h3 class="mb-2">EMT 2nd Attendant to EMT 1st Attendant Packet</h3>
          <p class="mb-1"></p>
          <p class="mb-0">Rating key: <strong>S</strong> Satisfactory, <strong>NI</strong> Needs Improvement, <strong>F</strong> Fail, <strong>NA</strong> Not Applicable.</p>
        </div>
        <div class="col-md-4 text-md-right mt-3 mt-md-0">
          <div class="packet-metric"><%= completedCalls || 0 %>/12</div>
          <div>Completed Call Sheets</div>
        </div>
      </div>
    </div>

    <div id="alertHost" class="mb-3 alert-host" aria-live="polite"></div>
    <% if (canCreatePacket) { %>
      <div class="modal fade" id="packetSetupModal" tabindex="-1" role="dialog" aria-labelledby="packetSetupModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="packetSetupModalLabel">Cover Page / Packet Setup</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div id="packetSetupModalAlert" class="alert d-none mb-3" role="alert" aria-live="assertive"></div>
              <form id="coverForm" data-default-sro="<%= user._id %>">
                <input type="hidden" id="packetId" name="packetId" value="<%= packet ? packet._id : '' %>">
                <input type="hidden" id="createNewPacket" name="createNew" value="0">
                <div class="form-row">
                  <div class="form-group col-md-4">
                    <label>EMT 2nd Attendant (Candidate)</label>
                    <select class="form-control" name="candidateId" required>
                      <option value="">Select candidate...</option>
                      <% users.forEach(member => { %>
                        <option value="<%= member._id %>" <%= packet && packet.candidate && packet.candidate._id.toString() === member._id.toString() ? 'selected' : '' %>>
                          <%= member.displayName %> (<%= member.email %>)
                        </option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="form-group col-md-4">
                    <label>Sponsoring Rescue Officer</label>
                    <select class="form-control" name="sponsoringRescueOfficerId" required>
                      <% users.forEach(member => { %>
                        <option value="<%= member._id %>" <%= packet && packet.sponsoringRescueOfficer && packet.sponsoringRescueOfficer._id.toString() === member._id.toString() ? 'selected' : (member._id.toString() === user._id.toString() ? 'selected' : '') %>>
                          <%= member.displayName %>
                        </option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="form-group col-md-4">
                    <label>Rescue Chief</label>
                    <select class="form-control" name="rescueChiefId">
                      <option value="">Select chief...</option>
                      <% users.forEach(member => { %>
                        <option value="<%= member._id %>" <%= packet && packet.rescueChief && packet.rescueChief._id.toString() === member._id.toString() ? 'selected' : '' %>>
                          <%= member.displayName %>
                        </option>
                      <% }); %>
                    </select>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group col-md-3">
                    <label>EMT Completion Date</label>
                    <input class="form-control" type="date" name="emtCompletionDate" value="<%= packet && packet.emtCompletionDate ? packet.emtCompletionDate.toISOString().slice(0,10) : '' %>">
                  </div>
                  <div class="form-group col-md-3">
                    <label>EMT 2nd Attendant Start Date</label>
                    <input class="form-control" type="date" name="secondAttendantStartDate" value="<%= packet && packet.secondAttendantStartDate ? packet.secondAttendantStartDate.toISOString().slice(0,10) : '' %>">
                  </div>
                  <div class="form-group col-md-6">
                    <label>Path to EMT 1st Attendant</label>
                    <select class="form-control" name="eligibilityPath" id="eligibilityPath">
                      <option value="trips" <%= !packet || packet.eligibilityPath === 'trips' ? 'selected' : '' %>>12 Emergency Trips</option>
                      <option value="one_year" <%= packet && packet.eligibilityPath === 'one_year' ? 'selected' : '' %>>One year as 2nd Attendant</option>
                      <option value="qualified_elsewhere" <%= packet && packet.eligibilityPath === 'qualified_elsewhere' ? 'selected' : '' %>>Already EMT 1st elsewhere</option>
                    </select>
                  </div>
                </div>

                <div class="form-group <%= packet && packet.eligibilityPath === 'qualified_elsewhere' ? '' : 'd-none' %>" id="elsewhereAgencyGroup">
                  <label>Qualified Elsewhere Agency</label>
                  <input class="form-control" type="text" name="qualifiedElsewhereAgency" value="<%= packet ? packet.qualifiedElsewhereAgency || '' : '' %>" placeholder="Company or police agency">
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="submit" form="coverForm" class="btn btn-primary" id="saveCoverButton">Save Cover Page</button>
              <button type="button" class="btn btn-outline-primary" id="createPacketBtn" data-create-packet>Create New Packet</button>
            </div>
          </div>
        </div>
      </div>
    <% } %>

    <% if (packet) { %>
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Cover Summary</span>
          <div class="d-flex gap-2">
            <% if (canCreatePacket) { %>
              <button type="button" class="btn btn-sm btn-outline-primary" id="editCoverSheetButton">Edit Cover Sheet</button>
            <% } %>
            <button type="button" class="btn btn-sm btn-outline-secondary" data-toggle="modal" data-target="#pdfScopeModal">Export PDF</button>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Candidate:</strong> <%= packet.candidate && packet.candidate.displayName ? packet.candidate.displayName : 'N/A' %></p>
              <p><strong>Sponsoring Rescue Officer:</strong> <%= packet.sponsoringRescueOfficer && packet.sponsoringRescueOfficer.displayName ? packet.sponsoringRescueOfficer.displayName : 'N/A' %></p>
              <p><strong>Rescue Chief:</strong> <%= packet.rescueChief && packet.rescueChief.displayName ? packet.rescueChief.displayName : 'Not assigned' %></p>
            </div>
            <div class="col-md-6">
              <p><strong>EMT Completion Date:</strong> <%= packet.emtCompletionDate ? packet.emtCompletionDate.toDateString() : 'N/A' %></p>
              <p><strong>2nd Attendant Start Date:</strong> <%= packet.secondAttendantStartDate ? packet.secondAttendantStartDate.toDateString() : 'N/A' %></p>
              <p><strong>Path:</strong> <%= packet.eligibilityPath.replace(/_/g, ' ') %> <%= packet.eligibilityPath === 'qualified_elsewhere' && packet.qualifiedElsewhereAgency ? `(${packet.qualifiedElsewhereAgency})` : '' %></p>
            </div>
          </div>
        </div>
      </div>

      <% if (packet.eligibilityPath === 'trips') { %>
        <div id="callSheets" class="accordion mb-4">
          <% packet.callSheets.sort((a, b) => a.callNumber - b.callNumber).forEach(call => { %>
            <div class="card mb-3">
              <div class="card-header" id="heading<%= call.callNumber %>">
                <button class="btn btn-link" data-toggle="collapse" data-target="#collapse<%= call.callNumber %>" aria-expanded="false" aria-controls="collapse<%= call.callNumber %>">
                  Call <%= call.callNumber %>
                  <span class="badge badge-info stage-badge"><%= call.status.replace(/_/g, ' ') %></span>
                </button>
              </div>
              <div id="collapse<%= call.callNumber %>" class="collapse" aria-labelledby="heading<%= call.callNumber %>" data-parent="#callSheets">
                <div class="card-body">
                  <% if (canEvaluateCallSheet) { %>
                    <form class="call-form mb-4" data-call-number="<%= call.callNumber %>">
                      <div class="form-row">
                        <div class="form-group col-md-4">
                          <label>Candidate Name</label>
                          <input class="form-control" name="candidateName" value="<%= call.candidateName || (packet.candidate ? packet.candidate.displayName : '') %>">
                        </div>
                        <div class="form-group col-md-4">
                          <label>Incident Date</label>
                          <input class="form-control" type="date" name="incidentDate" value="<%= call.incidentDate ? new Date(call.incidentDate).toISOString().slice(0,10) : '' %>">
                        </div>
                        <div class="form-group col-md-4">
                          <label>Patient Priority</label>
                          <input class="form-control" name="patientPriority" value="<%= call.patientPriority || '' %>">
                        </div>
                      </div>

                      <div class="form-row">
                        <div class="form-group col-md-6">
                          <label>Incident Type</label>
                          <input class="form-control" name="incidentType" value="<%= call.incidentType || '' %>">
                        </div>
                        <div class="form-group col-md-6">
                          <label>FC Incident #</label>
                          <input class="form-control" name="fcIncidentNumber" value="<%= call.fcIncidentNumber || '' %>">
                        </div>
                      </div>

                      <div class="form-group">
                        <label>Directions</label>
                        <textarea class="form-control" name="directions" rows="2"><%= call.directions || '' %></textarea>
                      </div>

                      <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                          <thead>
                            <tr>
                              <th>Skill</th>
                              <th style="width: 120px;">Rating</th>
                              <th>Category Comments</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% (call.skillRatings || []).forEach((skill, idx) => { %>
                              <tr class="skill-row">
                                <td>
                                  <%= skill.skill %>
                                  <input type="hidden" name="skillName" value="<%= skill.skill %>">
                                </td>
                                <td>
                                  <select class="form-control form-control-sm" name="skillRating">
                                    <% ratings.forEach(rate => { %>
                                      <option value="<%= rate %>" <%= skill.rating === rate ? 'selected' : '' %>><%= rate %></option>
                                    <% }) %>
                                  </select>
                                </td>
                                <td>
                                  <input class="form-control form-control-sm" name="skillComment" value="<%= skill.comments || '' %>">
                                </td>
                              </tr>
                            <% }) %>
                          </tbody>
                        </table>
                      </div>

                      <div class="form-group">
                        <label>Evaluator Comments</label>
                        <textarea class="form-control" name="evaluatorComments" rows="2"><%= call.evaluatorComments || '' %></textarea>
                      </div>

                      <div class="form-row">
                        <div class="form-group col-md-4">
                          <label>Candidate capable of functioning independently?</label>
                          <select class="form-control" name="independentFieldReady">
                            <option value="not_evaluated" <%= !call.independentFieldReady || call.independentFieldReady.value === 'not_evaluated' ? 'selected' : '' %>>Not evaluated</option>
                            <option value="yes" <%= call.independentFieldReady && call.independentFieldReady.value === 'yes' ? 'selected' : '' %>>Yes</option>
                            <option value="no" <%= call.independentFieldReady && call.independentFieldReady.value === 'no' ? 'selected' : '' %>>No (needs more work)</option>
                          </select>
                        </div>
                        <div class="form-group col-md-8">
                          <label>Guidance if additional evaluation is needed</label>
                          <input class="form-control" name="independentFieldComments" value="<%= call.independentFieldReady ? call.independentFieldReady.comments || '' : '' %>">
                        </div>
                      </div>

                      <button type="submit" class="btn btn-primary">Save Call Sheet (Evaluator)</button>
                    </form>
                  <% } %>

                  <div class="border rounded p-3 mb-3">
                    <h6>Signature Flow</h6>
                    <p class="signature-note mb-2">Evaluator fills call sheet, then candidate signs, then evaluator signs, then rescue officer signs.</p>
                    <div class="row">
                      <div class="col-md-4">
                        <strong>Candidate</strong><br>
                        <span><%= call.candidateSignature && call.candidateSignature.signedAt ? `${call.candidateSignature.name} (${new Date(call.candidateSignature.signedAt).toLocaleDateString()})` : 'Pending signature' %></span>
                        <% if (packet.candidate && packet.candidate._id && packet.candidate._id.toString() === user._id.toString()) { %>
                          <button class="btn btn-outline-primary btn-sm mt-2 sign-btn" data-call-number="<%= call.callNumber %>" data-sign-type="candidate">Candidate Sign</button>
                        <% } %>
                      </div>
                      <div class="col-md-4">
                        <strong>Evaluator</strong><br>
                        <span><%= call.evaluatorSignature && call.evaluatorSignature.signedAt ? `${call.evaluatorSignature.name} (${new Date(call.evaluatorSignature.signedAt).toLocaleDateString()})` : 'Pending signature' %></span>
                        <% if (canEvaluateCallSheet) { %>
                          <button class="btn btn-outline-primary btn-sm mt-2 sign-btn" data-call-number="<%= call.callNumber %>" data-sign-type="evaluator">Evaluator Sign</button>
                        <% } %>
                      </div>
                      <div class="col-md-4">
                        <strong>Rescue Officer</strong><br>
                        <span><%= call.rescueOfficerSignature && call.rescueOfficerSignature.signedAt ? `${call.rescueOfficerSignature.name} (${new Date(call.rescueOfficerSignature.signedAt).toLocaleDateString()})` : 'Pending signature' %></span>
                        <% if (canRescueOfficerSign) { %>
                          <button class="btn btn-outline-success btn-sm mt-2 sign-btn" data-call-number="<%= call.callNumber %>" data-sign-type="rescue-officer">Rescue Officer Sign</button>
                        <% } %>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      <% } %>

      <% if (canPerformFinalReview) { %>
        <div class="card mb-4" id="final-review">
          <div class="card-header">Final Rescue Chief Review</div>
          <div class="card-body">
            <form id="finalReviewForm">
              <div class="form-row">
                <div class="form-group col-md-4">
                  <label>EMT 1st Attendant Completion Date</label>
                  <input class="form-control" type="date" name="firstAttendantCompletionDate" value="<%= packet.finalReview && packet.finalReview.firstAttendantCompletionDate ? new Date(packet.finalReview.firstAttendantCompletionDate).toISOString().slice(0,10) : '' %>">
                </div>
                <div class="form-group col-md-4">
                  <label>Decision</label>
                  <select class="form-control" name="decision">
                    <option value="approved" <%= packet.finalReview && packet.finalReview.decision === 'approved' ? 'selected' : '' %>>EMT 1st Attendant Approved</option>
                    <option value="pending_more_evaluation" <%= !packet.finalReview || packet.finalReview.decision !== 'approved' ? 'selected' : '' %>>Pending More Evaluation Time</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>Rescue Chief Comments</label>
                <textarea class="form-control" rows="3" name="comments"><%= packet.finalReview ? packet.finalReview.comments || '' : '' %></textarea>
              </div>
              <button type="submit" class="btn btn-success">Save Final Review</button>
            </form>
          </div>
        </div>
      <% } %>

      <div class="modal fade" id="pdfScopeModal" tabindex="-1" role="dialog" aria-labelledby="pdfScopeModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="pdfScopeModalLabel">Export Packet PDF</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <form method="get" action="/training/attendant-packets/<%= packet._id %>/pdf">
              <div class="modal-body">
                <div class="form-group">
                  <label for="pdfScopeSelect">What should the PDF include?</label>
                  <select id="pdfScopeSelect" class="form-control" name="scope">
                    <option value="full">Full packet (all calls & cover sheet)</option>
                    <option value="completed">Completed calls only</option>
                    <option value="summary">Summary cover and final review</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Download PDF</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    <% } %>

    <div id="packetRuntime"
      data-packet-id="<%= packet ? packet._id : '' %>"
      data-can-manage="<%= isPacketManager ? '1' : '0' %>"
      data-can-evaluate="<%= canEvaluateCallSheet ? '1' : '0' %>"></div>
  </div>

  <%- include('./partials/footer') %>
  <%- include('./partials/scripts') %>
  <script>
    (function () {
      const runtimeData = document.getElementById('packetRuntime');
      const packetId = runtimeData ? runtimeData.dataset.packetId : '';
      const canManagePacket = runtimeData ? runtimeData.dataset.canManage === '1' : false;
      const canEvaluatePacket = runtimeData ? runtimeData.dataset.canEvaluate === '1' : false;
      const backToMyQualificationsButton = document.getElementById('backToMyQualificationsButton');
      if (backToMyQualificationsButton) {
        backToMyQualificationsButton.addEventListener('click', function (event) {
          event.preventDefault();
          event.stopImmediatePropagation();
          window.location.href = this.href;
        });
      }

      function showAlert(message, type = 'success') {
        const host = document.getElementById('alertHost');
        const wrapper = document.createElement('div');
        wrapper.className = `alert alert-${type} mt-2`;
        wrapper.textContent = message;
        host.prepend(wrapper);
        setTimeout(() => wrapper.remove(), 5000);
      }

      const packetSetupModalAlert = document.getElementById('packetSetupModalAlert');
      const showModalAlert = (message, type = 'danger') => {
        if (!packetSetupModalAlert) {
          showAlert(message, type);
          return;
        }
        packetSetupModalAlert.classList.remove('d-none', 'alert-danger', 'alert-success');
        packetSetupModalAlert.classList.add('alert', `alert-${type}`);
        packetSetupModalAlert.textContent = message;
      };
      const clearModalAlert = () => {
        if (!packetSetupModalAlert) {
          return;
        }
        packetSetupModalAlert.classList.add('d-none');
        packetSetupModalAlert.textContent = '';
      };

      const pulseCandidateField = () => {
        if (!coverForm) {
          return;
        }
        const field = coverForm.querySelector('select[name="candidateId"]');
        if (!field) {
          return;
        }
        field.classList.remove('pulse-border');
        void field.offsetWidth;
        field.classList.add('pulse-border');
        setTimeout(() => field.classList.remove('pulse-border'), 3200);
      };

      async function postJson(url, payload) {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload || {})
        });
        const data = await response.json();
        if (!response.ok || !data.success) {
          throw new Error(data.error || 'Request failed');
        }
        return data;
      }

      const eligibilityPath = document.getElementById('eligibilityPath');
      const elsewhereAgencyGroup = document.getElementById('elsewhereAgencyGroup');
      if (eligibilityPath && elsewhereAgencyGroup) {
        eligibilityPath.addEventListener('change', () => {
          elsewhereAgencyGroup.classList.toggle('d-none', eligibilityPath.value !== 'qualified_elsewhere');
        });
      }

      const coverForm = document.getElementById('coverForm');
      const packetSetupModalElement = document.getElementById('packetSetupModal');
      const modalSaveButton = document.getElementById('saveCoverButton');
      const modalCreateButton = document.getElementById('createPacketBtn');
      const setModalActionMode = (mode) => {
        const isEdit = mode === 'edit';
        if (modalSaveButton) {
          modalSaveButton.classList.toggle('d-none', !isEdit);
        }
        if (modalCreateButton) {
          modalCreateButton.classList.toggle('d-none', isEdit);
        }
      };
      const showPacketSetupModal = () => {
        if (!packetSetupModalElement) {
          return;
        }
        const mode = packetSetupModalElement.dataset.mode || 'create';
        setModalActionMode(mode);
        clearModalAlert();
        if (window.jQuery && typeof window.jQuery(packetSetupModalElement).modal === 'function') {
          window.jQuery(packetSetupModalElement).modal('show');
          return;
        }
        packetSetupModalElement.classList.add('show');
        packetSetupModalElement.style.display = 'block';
        packetSetupModalElement.setAttribute('aria-hidden', 'false');
      };

      const editCoverSheetButton = document.getElementById('editCoverSheetButton');
      if (editCoverSheetButton) {
        editCoverSheetButton.addEventListener('click', (event) => {
          event.preventDefault();
          if (!packetSetupModalElement) {
            showAlert('Packet setup form is not available.', 'danger');
            return;
          }
          packetSetupModalElement.dataset.mode = 'edit';
          const createFlag = document.getElementById('createNewPacket');
          if (createFlag) {
            createFlag.value = '0';
          }
          setModalActionMode('edit');
          showPacketSetupModal();
        });
      }

      const prepareNewPacketForm = () => {
        if (!coverForm) {
          return;
        }
        if (packetSetupModalElement) {
          packetSetupModalElement.dataset.mode = 'create';
        }
        const setFieldValue = (name, value) => {
          const field = coverForm.querySelector(`[name="${name}"]`);
          if (field) {
            field.value = value;
            field.dispatchEvent(new Event('change', { bubbles: true }));
          }
        };
        const packetIdField = document.getElementById('packetId');
        if (packetIdField) {
          packetIdField.value = '';
        }
        const createFlag = document.getElementById('createNewPacket');
        if (createFlag) {
          createFlag.value = '0';
        }
        setModalActionMode('create');
        setFieldValue('candidateId', '');
        setFieldValue('rescueChiefId', '');
        setFieldValue('emtCompletionDate', '');
        setFieldValue('secondAttendantStartDate', '');
        setFieldValue('qualifiedElsewhereAgency', '');
        const eligibilityPathField = document.getElementById('eligibilityPath');
        if (eligibilityPathField) {
          eligibilityPathField.value = 'trips';
          eligibilityPathField.dispatchEvent(new Event('change', { bubbles: true }));
        }
        const defaultSroId = coverForm.dataset.defaultSro || '';
        if (defaultSroId) {
          setFieldValue('sponsoringRescueOfficerId', defaultSroId);
        }
      };
      const createPacketTriggers = Array.from(document.querySelectorAll('[data-create-packet]'));
      const triggerCreatePacket = () => {
        if (!coverForm) {
          showAlert('Packet setup form is not available.', 'danger');
          return;
        }
        const createFlag = document.getElementById('createNewPacket');
        if (createFlag) {
          createFlag.value = '1';
        }
        const packetIdField = document.getElementById('packetId');
        if (packetIdField) {
          packetIdField.value = '';
        }
        coverForm.requestSubmit();
      };

      if (createPacketTriggers.length) {
        createPacketTriggers.forEach(trigger => {
          trigger.addEventListener('click', (event) => {
            event.preventDefault();
            if (trigger.dataset.packetSetupMode === 'launcher') {
              prepareNewPacketForm();
              showPacketSetupModal();
              return;
            }
            triggerCreatePacket();
          });
        });
      }

      if (coverForm) {
        coverForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          try {
            const formData = new FormData(coverForm);
            const payload = Object.fromEntries(formData.entries());
            if (!payload.packetId) {
              payload.createNew = '1';
            }
            const result = await postJson('/qualifications/attendant-packet/cover', payload);
            showAlert('Cover page saved.');
            const newPacketId = result.packetId || payload.packetId;
            if (newPacketId) {
              window.location.href = `/qualifications/attendant-packet?packet=${newPacketId}`;
            }
          } catch (error) {
            const duplicateText = 'already has an attendant packet';
            const message = error.message || 'Request failed';
            if (message.toLowerCase().includes(duplicateText)) {
              showModalAlert(message, 'danger');
            } else {
              showAlert(message, 'danger');
            }
            pulseCandidateField();
          } finally {
            const createFlag = document.getElementById('createNewPacket');
            if (createFlag) {
              createFlag.value = '0';
            }
          }
        });
      }

      document.querySelectorAll('.call-form').forEach((formEl) => {
        formEl.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!packetId || !canEvaluatePacket) {
            showAlert('No active packet selected.', 'danger');
            return;
          }

          const callNumber = formEl.dataset.callNumber;
          const fieldData = new FormData(formEl);
          const skillNames = fieldData.getAll('skillName');
          const skillRatings = fieldData.getAll('skillRating');
          const skillComments = fieldData.getAll('skillComment');

          const payload = {
            candidateName: fieldData.get('candidateName'),
            incidentDate: fieldData.get('incidentDate'),
            patientPriority: fieldData.get('patientPriority'),
            incidentType: fieldData.get('incidentType'),
            fcIncidentNumber: fieldData.get('fcIncidentNumber'),
            directions: fieldData.get('directions'),
            evaluatorComments: fieldData.get('evaluatorComments'),
            independentFieldReady: fieldData.get('independentFieldReady'),
            independentFieldComments: fieldData.get('independentFieldComments'),
            skillRatings: skillNames.map((name, index) => ({
              skill: name,
              rating: skillRatings[index] || 'NA',
              comments: skillComments[index] || ''
            }))
          };

          try {
            await postJson(`/qualifications/attendant-packet/${packetId}/calls/${callNumber}`, payload);
            showAlert(`Call ${callNumber} saved and set to awaiting candidate signature.`);
            setTimeout(() => window.location.reload(), 600);
          } catch (error) {
            showAlert(error.message, 'danger');
          }
        });
      });

      document.querySelectorAll('.sign-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          if (!packetId) {
            showAlert('No active packet selected.', 'danger');
            return;
          }

          const callNumber = btn.dataset.callNumber;
          const signType = btn.dataset.signType;
          const routeMap = {
            candidate: 'candidate-sign',
            evaluator: 'evaluator-sign',
            'rescue-officer': 'rescue-officer-sign'
          };

          try {
            await postJson(`/qualifications/attendant-packet/${packetId}/calls/${callNumber}/${routeMap[signType]}`, {});
            showAlert(`Call ${callNumber} ${signType.replace('-', ' ')} signature saved.`);
            setTimeout(() => window.location.reload(), 600);
          } catch (error) {
            showAlert(error.message, 'danger');
          }
        });
      });

      const finalReviewForm = document.getElementById('finalReviewForm');
      if (finalReviewForm) {
        finalReviewForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!packetId) {
            showAlert('No active packet selected.', 'danger');
            return;
          }

          const payload = Object.fromEntries(new FormData(finalReviewForm).entries());
          try {
            await postJson(`/qualifications/attendant-packet/${packetId}/final-review`, payload);
            showAlert('Final review saved.');
            setTimeout(() => window.location.reload(), 600);
          } catch (error) {
            showAlert(error.message, 'danger');
          }
        });
      }

      const openTargetFromHash = () => {
        const hash = window.location.hash;
        if (!hash) {
          return;
        }

        const target = document.querySelector(hash);
        if (!target) {
          return;
        }

        const openAndFocus = () => {
          const card = target.closest('.card');
          if (card) {
            card.classList.add('call-targeted');
            setTimeout(() => card.classList.remove('call-targeted'), 3000);
          }

          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        if (target.classList.contains('collapse') && typeof window.jQuery === 'function') {
          window.jQuery(target).collapse('show');
          setTimeout(openAndFocus, 220);
        } else {
          openAndFocus();
        }
      };

      openTargetFromHash();
      const navigateToPacket = (selectedId) => {
        if (!selectedId) {
          return;
        }
        const nextUrl = new URL(window.location.href);
        nextUrl.hash = '';
        nextUrl.searchParams.set('packet', selectedId);
        window.location.assign(nextUrl.toString());
      };

      const packetSearchInput = document.getElementById('packetSearchInput');
      const packetStatusFilter = document.getElementById('packetStatusFilter');
      const packetCards = Array.from(document.querySelectorAll('.packet-card'));
      const filterPacketCards = () => {
        if (!packetCards.length) {
          return;
        }
        const searchValue = packetSearchInput ? packetSearchInput.value.trim().toLowerCase() : '';
        const statusValue = packetStatusFilter ? packetStatusFilter.value : '';
        packetCards.forEach((card) => {
          const candidate = card.dataset.candidate ? card.dataset.candidate.toLowerCase() : '';
          const officer = card.dataset.officer ? card.dataset.officer.toLowerCase() : '';
          const path = card.dataset.path ? card.dataset.path.toLowerCase() : '';
          const status = card.dataset.status || '';
          const matchesSearch = !searchValue || [candidate, officer, path, status].some(text => text.includes(searchValue));
          const matchesStatus = !statusValue || status === statusValue;
          const shouldShow = matchesSearch && matchesStatus;
          card.classList.toggle('d-none', !shouldShow);
        });
      };

      if (packetSearchInput) {
        packetSearchInput.addEventListener('input', filterPacketCards);
      }
      if (packetStatusFilter) {
        packetStatusFilter.addEventListener('change', filterPacketCards);
      }
      filterPacketCards();

      const navigateFromCard = (packetIdValue) => {
        navigateToPacket(packetIdValue);
      };

      packetCards.forEach((card) => {
        card.addEventListener('click', () => navigateFromCard(card.dataset.packetId));
        card.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            navigateFromCard(card.dataset.packetId);
          }
        });
      });

      document.querySelectorAll('.packet-card-open').forEach((btn) => {
        btn.addEventListener('click', (event) => {
          event.stopPropagation();
          navigateFromCard(btn.dataset.packetId);
        });
      });

      const packetSelect = document.querySelector('select[name="packet"]');
      if (packetSelect) {
        packetSelect.addEventListener('change', () => {
          navigateToPacket(packetSelect.value);
        });
      }
    })();
  </script>
</body>
</html>
