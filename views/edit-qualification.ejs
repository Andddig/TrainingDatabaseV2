<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Qualification - Training Database</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/sortable.min.js"></script>
</head>
<body>
    <%- include('./partials/header', { user }) %>
    
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col">
                <h1><i class="fas fa-cogs text-primary mr-2"></i>Edit Qualification</h1>
            </div>
            <div class="col-auto">
                <a href="/qualifications/manage" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Qualifications
                </a>
            </div>
        </div>
        
        <% if (error) { %>
            <div class="alert alert-danger"><%= error %></div>
        <% } %>
        
        <% if (success) { %>
            <div class="alert alert-success"><%= success %></div>
        <% } %>
        
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Qualification Details</h5>
            </div>
            <div class="card-body">
                <form action="/qualifications/update/<%= qualification._id %>" method="POST">
                    <div class="form-group">
                        <label for="name">Qualification Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name" value="<%= qualification.name %>" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"><%= qualification.description %></textarea>
                    </div>
                    <div class="form-group">
                        <label>Required Training Classes <span class="text-danger">*</span></label>
                        <div class="transfer-list">
                            <div class="transfer-list-column">
                                <div class="transfer-list-header">Available Classes</div>
                                <div class="transfer-list-items" id="availableClasses">
                                    <% if (trainingClasses && trainingClasses.length > 0) { %>
                                        <% trainingClasses.forEach(classItem => { %>
                                            <% if (!qualification.requiredClasses.some(c => c._id.toString() === classItem._id.toString())) { %>
                                                <div class="transfer-list-item" data-id="<%= classItem._id %>">
                                                    <%= classItem.name %>
                                                </div>
                                            <% } %>
                                        <% }); %>
                                    <% } else { %>
                                        <div class="alert alert-warning mb-0">
                                            <i class="fas fa-exclamation-triangle mr-2"></i> No training classes are available.
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                            <div class="transfer-list-controls">
                                <button type="button" class="btn btn-outline-primary" id="addClass" title="Add selected classes">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="removeClass" title="Remove selected classes">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                            </div>
                            <div class="transfer-list-column">
                                <div class="transfer-list-header">Selected Classes</div>
                                <div class="transfer-list-items" id="selectedClasses">
                                    <% if (qualification.requiredClasses && qualification.requiredClasses.length > 0) { %>
                                        <% qualification.requiredClasses.forEach(classItem => { %>
                                            <div class="transfer-list-item" data-id="<%= classItem._id %>">
                                                <%= classItem.name %>
                                            </div>
                                        <% }); %>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="requiredClasses" id="requiredClasses">
                        <small class="form-text text-muted">Order matters - list classes in the order they should be completed.</small>
                    </div>
                    <div class="form-group text-right">
                        <a href="/qualifications/manage" class="btn btn-secondary mr-2">
                            <i class="fas fa-times mr-1"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-1"></i> Update Qualification
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <%- include('./partials/footer') %>
    <%- include('./partials/scripts') %>
    
    <script>
        $(document).ready(function() {
            // Initialize Sortable for both lists
            const availableClasses = new Sortable(document.getElementById('availableClasses'), {
                group: 'shared',
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: function() {
                    updateRequiredClassesInput();
                }
            });

            const selectedClasses = new Sortable(document.getElementById('selectedClasses'), {
                group: 'shared',
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: function() {
                    updateRequiredClassesInput();
                }
            });

            // Add class to selected
            $('#addClass').on('click', function() {
                const selectedItems = $('#availableClasses .transfer-list-item.selected');
                if (selectedItems.length > 0) {
                    selectedItems.appendTo('#selectedClasses');
                    updateRequiredClassesInput();
                }
            });

            // Remove class from selected
            $('#removeClass').on('click', function() {
                const selectedItems = $('#selectedClasses .transfer-list-item.selected');
                if (selectedItems.length > 0) {
                    selectedItems.appendTo('#availableClasses');
                    updateRequiredClassesInput();
                }
            });

            // Toggle selection on click
            $(document).on('click', '.transfer-list-item', function(e) {
                if (!$(e.target).is('button, a, input')) {
                    $(this).toggleClass('selected');
                    updateButtonStates();
                }
            });

            // Update button states based on selection
            function updateButtonStates() {
                const hasSelectedAvailable = $('#availableClasses .transfer-list-item.selected').length > 0;
                const hasSelectedSelected = $('#selectedClasses .transfer-list-item.selected').length > 0;
                
                $('#addClass').prop('disabled', !hasSelectedAvailable);
                $('#removeClass').prop('disabled', !hasSelectedSelected);
            }

            // Update the hidden input with selected class IDs
            function updateRequiredClassesInput() {
                const selectedIds = [];
                $('#selectedClasses .transfer-list-item').each(function() {
                    selectedIds.push($(this).data('id'));
                });
                // Format the IDs as a comma-separated string
                $('#requiredClasses').val(selectedIds.join(','));
                updateButtonStates();
            }

            // Initialize the form
            updateButtonStates();
            updateRequiredClassesInput();
        });
    </script>
</body>
</html> 