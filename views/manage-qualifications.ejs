<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; font-src 'self';">
    <title>Manage Qualifications</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/sortable.min.js"></script>
    <script src="/js/confetti.browser.min.js"></script>
    <style>
        .transfer-list {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .transfer-list-column {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            min-height: 300px;
            background: #fff;
        }
        .transfer-list-header {
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }
        .transfer-list-items {
            min-height: 250px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .transfer-list-item {
            padding: 8px;
            margin-bottom: 5px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: move;
            user-select: none;
        }
        .transfer-list-item:hover {
            background: #e9ecef;
        }
        .transfer-list-item.selected {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        .transfer-list-controls {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 10px;
            padding: 0 10px;
        }
        .transfer-list-controls button {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #fff;
            border: 1px solid #ddd;
            color: #666;
            font-size: 1.2rem;
        }
        .transfer-list-controls button:hover {
            background: #f8f9fa;
            color: #333;
        }
        .transfer-list-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #e3f2fd;
        }
        .sortable-drag {
            opacity: 0.8;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* Ensure modal is properly displayed */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            overflow: hidden;
            outline: 0;
        }
        .modal.show {
            display: block;
        }
        .modal-dialog {
            position: relative;
            width: auto;
            margin: 0.5rem;
            pointer-events: none;
        }
        @media (min-width: 576px) {
            .modal-dialog {
                max-width: 800px;
                margin: 1.75rem auto;
            }
        }
    </style>
</head>
<body>
    <%- include('./partials/header', { user }) %>
    
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col">
                <h1><i class="fas fa-cogs text-primary mr-2"></i>Manage Qualifications</h1>
                <p class="lead">Define qualification levels and their required training classes.</p>
            </div>
            <div class="col-auto d-flex align-items-center">
                <button type="button" class="btn btn-primary" id="addQualificationBtn">
                    <i class="fas fa-plus-circle mr-1"></i> Add Qualification
                </button>
            </div>
        </div>

        <% if (locals.error) { %>
            <div class="alert alert-danger"><%= error %></div>
        <% } %>
        
        <% if (locals.success) { %>
            <div class="alert alert-success"><%= success %></div>
        <% } %>

        <div class="card shadow-sm">
            <div class="card-body">
                <% if (qualifications && qualifications.length > 0) { %>
                    <div class="table-responsive">
                        <table class="table table-striped qualification-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Required Classes</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% qualifications.forEach(qualification => { %>
                                    <tr>
                                        <td><strong><%= qualification.name %></strong></td>
                                        <td><%= qualification.description %></td>
                                        <td>
                                            <% if (qualification.requiredClasses && qualification.requiredClasses.length > 0) { %>
                                                <button class="btn btn-sm btn-outline-info" type="button" data-toggle="collapse" data-target="#classes<%= qualification._id %>" aria-expanded="false" aria-controls="classes<%= qualification._id %>">
                                                    <i class="fas fa-clipboard-list mr-1"></i> Show <%= qualification.requiredClasses.length %> classes
                                                </button>
                                                <div class="collapse" id="classes<%= qualification._id %>">
                                                    <ul class="list-group mt-2">
                                                        <% qualification.requiredClasses.forEach(classItem => { %>
                                                            <li class="list-group-item py-2"><i class="fas fa-graduation-cap text-secondary mr-2"></i><%= classItem.name %></li>
                                                        <% }); %>
                                                    </ul>
                                                </div>
                                            <% } else { %>
                                                <span class="text-muted"><i class="fas fa-exclamation-circle mr-1"></i> No classes defined</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <% if (qualification.isActive) { %>
                                                <span class="status-complete"><i class="fas fa-check-circle mr-1"></i> Active</span>
                                            <% } else { %>
                                                <span class="status-in-progress"><i class="fas fa-pause-circle mr-1"></i> Inactive</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <div class="qualification-actions">
                                                <a href="/qualifications/edit/<%= qualification._id %>" class="btn btn-sm btn-primary">
                                                    <i class="fas fa-edit"></i> Edit
                                                </a>
                                                <form action="/qualifications/toggle-status/<%= qualification._id %>" method="POST" class="d-inline">
                                                    <button type="submit" class="btn btn-sm <%= qualification.isActive ? 'btn-warning' : 'btn-success' %>">
                                                        <i class="fas <%= qualification.isActive ? 'fa-pause' : 'fa-play' %> mr-1"></i>
                                                        <%= qualification.isActive ? 'Deactivate' : 'Activate' %>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle mr-2"></i> No qualifications have been defined yet. Click "Add Qualification" to create one.
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Add Qualification Modal -->
    <div class="modal fade" id="addQualificationModal" tabindex="-1" role="dialog" aria-labelledby="addQualificationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="addQualificationModalLabel"><i class="fas fa-plus-circle mr-2"></i>Add New Qualification</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form action="/qualifications/add" method="POST">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="name">Qualification Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Required Training Classes <span class="text-danger">*</span></label>
                            <div class="transfer-list">
                                <div class="transfer-list-column">
                                    <div class="transfer-list-header">Available Classes</div>
                                    <div class="transfer-list-items" id="availableClasses">
                                        <% if (trainingClasses && trainingClasses.length > 0) { %>
                                            <% trainingClasses.forEach(classItem => { %>
                                                <div class="transfer-list-item" data-id="<%= classItem._id %>">
                                                    <%= classItem.name %>
                                                </div>
                                            <% }); %>
                                        <% } else { %>
                                            <div class="alert alert-warning mb-0">
                                                <i class="fas fa-exclamation-triangle mr-2"></i> No training classes are available.
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                                <div class="transfer-list-controls">
                                    <button type="button" class="btn btn-outline-primary" id="addClass" title="Add selected classes">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="removeClass" title="Remove selected classes">
                                        <i class="fas fa-arrow-left"></i>
                                    </button>
                                </div>
                                <div class="transfer-list-column">
                                    <div class="transfer-list-header">Selected Classes</div>
                                    <div class="transfer-list-items" id="selectedClasses">
                                        <!-- Selected classes will be added here -->
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="requiredClasses" id="requiredClasses">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                            <i class="fas fa-times mr-1"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-1"></i> Create Qualification
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <%- include('./partials/footer') %>
    
    <script>
      $(document).ready(function() {
                if (typeof confetti === 'function' && document.querySelector('.alert.alert-success')) {
                    confetti({
                        particleCount: 110,
                        spread: 80,
                        origin: { y: 0.65 }
                    });

                    setTimeout(function() {
                        confetti({
                            particleCount: 80,
                            spread: 60,
                            origin: { y: 0.7 }
                        });
                    }, 280);
                }

        // Add qualification button click handler
        $('#addQualificationBtn').on('click', function() {
          $('#addQualificationModal').modal('show');
        });

        // Make sure all collapse elements are initialized as hidden
        $('.collapse').collapse('hide');
        
        // Toggle button text between 'Show' and 'Hide' when clicked
        $('[data-toggle="collapse"]').on('click', function() {
          const target = $($(this).data('target'));
          const text = $(this).html();
          
          if (target.hasClass('show')) {
            $(this).html(text.replace('Hide', 'Show'));
          } else {
            $(this).html(text.replace('Show', 'Hide'));
          }
        });

        // Initialize Sortable for both lists
        const availableClasses = new Sortable(document.getElementById('availableClasses'), {
          group: 'shared',
          animation: 150,
          ghostClass: 'sortable-ghost',
          dragClass: 'sortable-drag',
          onEnd: function() {
            updateRequiredClassesInput();
          }
        });

        const selectedClasses = new Sortable(document.getElementById('selectedClasses'), {
          group: 'shared',
          animation: 150,
          ghostClass: 'sortable-ghost',
          dragClass: 'sortable-drag',
          onEnd: function() {
            updateRequiredClassesInput();
          }
        });

        // Add class to selected
        $('#addClass').on('click', function() {
          const selectedItems = $('#availableClasses .transfer-list-item.selected');
          if (selectedItems.length > 0) {
            selectedItems.appendTo('#selectedClasses');
            updateRequiredClassesInput();
          }
        });

        // Remove class from selected
        $('#removeClass').on('click', function() {
          const selectedItems = $('#selectedClasses .transfer-list-item.selected');
          if (selectedItems.length > 0) {
            selectedItems.appendTo('#availableClasses');
            updateRequiredClassesInput();
          }
        });

        // Toggle selection on click
        $(document).on('click', '.transfer-list-item', function(e) {
          if (!$(e.target).is('button, a, input')) {
            $(this).toggleClass('selected');
            updateButtonStates();
          }
        });

        // Update button states based on selection
        function updateButtonStates() {
          const hasSelectedAvailable = $('#availableClasses .transfer-list-item.selected').length > 0;
          const hasSelectedSelected = $('#selectedClasses .transfer-list-item.selected').length > 0;
          
          $('#addClass').prop('disabled', !hasSelectedAvailable);
          $('#removeClass').prop('disabled', !hasSelectedSelected);
        }

        // Update the hidden input with selected class IDs
        function updateRequiredClassesInput() {
          const selectedIds = [];
          $('#selectedClasses .transfer-list-item').each(function() {
            selectedIds.push($(this).data('id'));
          });
          $('#requiredClasses').val(selectedIds.join(','));
          updateButtonStates();
        }

        // Initialize the form
        updateButtonStates();
        updateRequiredClassesInput();

        // Handle modal show event
        $('#addQualificationModal').on('show.bs.modal', function() {
          // Reset the form
          $('#name').val('');
          $('#description').val('');
          $('#selectedClasses').empty();
          $('#requiredClasses').val('');
          updateButtonStates();
        });
      });
    </script>
</body>
</html> 